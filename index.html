<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>音樂教室預約</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  
  <style>
	.selected {
		background-color: #fde68a !important; /* 黃色高亮 */
	}
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-2xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4 text-center">音樂教室預約系統</h1>

    <!-- 教室按鈕 -->
    <div class="grid grid-cols-2 gap-4 mb-6">
		<button onclick="selectRoom('小琴房')" class="room-button bg-white rounded-xl p-4 shadow hover:bg-yellow-100 transition-colors duration-300">小琴房</button>
		<button onclick="selectRoom('大琴房')" class="room-button bg-white rounded-xl p-4 shadow hover:bg-yellow-100 transition-colors duration-300">大琴房</button>
		<button onclick="selectRoom('平台琴房')" class="room-button bg-white rounded-xl p-4 shadow hover:bg-yellow-100 transition-colors duration-300">平台琴房</button>
		<button onclick="selectRoom('地下室')" class="room-button bg-white rounded-xl p-4 shadow hover:bg-yellow-100 transition-colors duration-300">地下室</button>
		<button onclick="selectRoom('活動場地')" class="room-button bg-white rounded-xl p-4 shadow hover:bg-yellow-100 transition-colors duration-300">活動場地</button>
	</div>

    <!-- 日曆顯示區 -->
    <div id="calendar" class="mb-6 hidden">
      <h2 class="text-xl font-semibold mb-2" id="calendar-title"></h2>
      <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
    </div>

    <!-- 時間選擇區 -->
    <div id="time-picker" class="hidden">
      <label for="start-time" class="block mb-2">開始時間：</label>
      <input type="time" id="start-time" class="w-full p-2 border rounded mb-4">

      <label for="end-time" class="block mb-2">結束時間：</label>
      <input type="time" id="end-time" class="w-full p-2 border rounded mb-4">

      <button onclick="submitReservation()" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">送出預約</button>
    </div>

    <!-- 回饋訊息 -->
    <p id="message" class="mt-4 text-center font-medium"></p>
  </div>



  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>  <!-- SupaBase 後端 -->
  <script>
	const supabaseUrl = 'https://vvhsucjkomeffodahhdu.supabase.co';
	const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2aHN1Y2prb21lZmZvZGFoaGR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM4Mjk5MzUsImV4cCI6MjA1OTQwNTkzNX0.iSR2lb4aztu68xFMgekFwOQXTYprezf3bIJprn2zyio';
	const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);  // ✅ 改名避免命名衝突

    let selectedRoom = '';
    let selectedDate = '';

    function selectRoom(room) {
    selectedRoom = room;

    // 移除所有教室按鈕的 selected 樣式
    document.querySelectorAll('.room-button').forEach(btn => btn.classList.remove('selected'));

    // 把選到的按鈕加上樣式
    const roomButtons = document.querySelectorAll('button');
    roomButtons.forEach(btn => {
      if (btn.textContent === room) {
        btn.classList.add('selected');
      }
    });

    document.getElementById('calendar').classList.remove('hidden');
    buildCalendar(); // 每次選房間都重建日曆
	}

    function buildCalendar() {
		const calendarGrid = document.getElementById('calendar-grid');
		const calendarTitle = document.getElementById('calendar-title');
		calendarGrid.innerHTML = '';

		const today = new Date();
		const todayOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
		const lastAllowedDate = new Date(todayOnly);
		lastAllowedDate.setDate(lastAllowedDate.getDate() + 30);

		calendarTitle.innerText = `請選擇日期（未來 30 天內）`;

		// 計算要顯示的兩個月
		const thisMonth = today.getMonth();
		const thisYear = today.getFullYear();

		const monthsToShow = [0, 1]; // 本月與下月

		monthsToShow.forEach(offset => {
			const monthDate = new Date(thisYear, thisMonth + offset);
			const year = monthDate.getFullYear();
			const month = monthDate.getMonth();

			// 月份標題
			const monthLabel = document.createElement('div');
			monthLabel.className = "col-span-7 font-bold text-lg mt-4";
			monthLabel.innerText = `${year}年${month + 1}月`;
			calendarGrid.appendChild(monthLabel);

			const firstDay = new Date(year, month, 1).getDay();
			const daysInMonth = new Date(year, month + 1, 0).getDate();

			for (let i = 0; i < firstDay; i++) {
			calendarGrid.innerHTML += '<div></div>';
			}

			for (let d = 1; d <= daysInMonth; d++) {
			const date = new Date(year, month, d);

			const dateBtn = document.createElement('button');
			dateBtn.innerText = d;
			dateBtn.className = 'bg-white rounded-lg p-2 shadow transition-colors duration-300 hover:bg-yellow-100';

			if (date < todayOnly || date > lastAllowedDate) {
				dateBtn.classList.add('opacity-30');
				dateBtn.disabled = true;
			} else {
				dateBtn.onclick = () => {
				selectedDate = `${year}-${(month + 1).toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
				document.querySelectorAll('#calendar-grid button').forEach(b => b.classList.remove('selected'));
				dateBtn.classList.add('selected');
				document.getElementById('time-picker').classList.remove('hidden');
				document.getElementById('message').innerText = `選擇日期：${selectedDate}`;
				};
			}

			calendarGrid.appendChild(dateBtn);
			}
		});
	}

    async function submitReservation() {
		const startTime = document.getElementById('start-time').value;
		const endTime = document.getElementById('end-time').value;

		if (!selectedRoom || !selectedDate || !startTime || !endTime) {
			alert('請填寫所有預約資料！');
			return;
		}
	
		// ⚠️ 查詢是否有時間重疊的預約
		const { data: existingReservations, error: queryError } = await supabaseClient
			.from('reservations')
			.select('*')
			.eq('room', selectedRoom)
			.eq('date', selectedDate)
			.or(`and(start_time,lt.${endTime}),and(end_time,gt.${startTime})`);

		if (queryError) {
			document.getElementById('message').innerText = `❌ 查詢失敗：${queryError.message}`;
		return;
		}

		if (existingReservations.length > 0) {
			document.getElementById('message').innerText = '❌ 時段已被預約，請選擇其他時間';
		return;
		}

		// 沒有衝突就送出預約
		const { data, error } = await supabaseClient.from('reservations').insert([{
			room: selectedRoom,
			date: selectedDate,
			start_time: startTime,
			end_time: endTime
		}]);

		if (error) {
			document.getElementById('message').innerText = `❌ 預約失敗：${error.message}`;
		} else {
		document.getElementById('message').innerText = `✅ 預約成功！`;
		}
	}

  </script>
</body>
</html>
